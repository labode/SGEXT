/* ********************************************************************
 * Copyright (C) 2020 Pablo Hernandez-Cerdan.
 *
 * This file is part of SGEXT: http://github.com/phcerdan/sgext.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 * *******************************************************************/

#include "write_vtk_file.hpp"

#include <vtkSmartPointer.h>
#include <vtkCellArray.h>
#include <vtkXMLUnstructuredGridReader.h>
#include <vtkDataSetMapper.h>
#include <vtkXMLUnstructuredGridWriter.h>
#include <vtkUnstructuredGrid.h>
#include <vtkPointData.h>
#include <vtkVertexGlyphFilter.h>
#include <vtkCellData.h>
#include <vtkLine.h>
#include <vtkDoubleArray.h>

namespace SG {
void write_vtk_file(const System & sys, const std::string & file_name) {
  auto ugrid = vtkUnstructuredGrid::New();
  // Allocate Number of cells, i.e number of bonds in the system;
  // TODO: Compute exactly, instead of 3* approximation.
  ugrid->Allocate(sys.bonds.collection.size() * 3);
  // Set geometry with position of points
  auto vtk_points = vtkSmartPointer<vtkPoints>::New();
  using particle_id_t = size_t;
  std::unordered_map<particle_id_t, vtkIdType> particle_id_to_vtk_id_map;
  for( const auto & particle : sys.all.particles) {
      const auto & pos = particle.pos;
      particle_id_to_vtk_id_map[particle.id] =
          vtk_points->InsertNextPoint(pos[0], pos[1], pos[2]);
  }
  ugrid->SetPoints(vtk_points);
  // Set topology using bonds
  auto unique_bonds = SG::unique_bonds(sys);
  for(const auto & bond : unique_bonds) {
      auto vtk_id_list = vtkIdList::New();
      vtk_id_list->InsertNextId(particle_id_to_vtk_id_map[source_particle_id]);
      vtk_id_list->InsertNextId(particle_id_to_vtk_id_map[neigh]);
      auto line = vtkLine::New();
      ugrid->InsertNextCell(line->GetCellType(), vtk_id_list);
  }
  // TODO: Insert extra PointData: acc, vel, etc
  // auto point_data = ugrid->GetPointData();
  // auto acc = vtkDoubleArray::New();
  // acc->SetName("Acceleration");
  // acc->SetNumberOfValues(3);
  // for( const auto & particle : sys.all.particles) {
  //     acc->SetValue(0, particle.dynamics.acc[0]);
  //     acc->SetValue(1, particle.dynamics.acc[1]);
  //     acc->SetValue(2, particle.dynamics.acc[2]);
  // }
  // point_data->AddArray(acc);
  // point_data->Update();

  auto ugrid_writer = vtkXMLUnstructuredGridWriter::New();
  ugrid_writer->SetFileName(file_name.c_str());
  ugrid_writer->SetInputData(ugrid);
  ugrid_writer->Update();
}
} // end namespace
